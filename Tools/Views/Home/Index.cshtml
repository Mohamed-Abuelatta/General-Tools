@using System.Data;
@using Newtonsoft.Json;
@using System.Web;
@using Tools.Tools.Grid;
@model InitGrid

<style type="text/css">

    table {
        width: 100%;
    }

    td {
        width: 200px;
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==) repeat;
    }

    td, th {
        padding: 15px 10px;
        border: 1px solid #999;
        text-align: right;
    }

    .th, .th a {
        background: gray;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 2px 5px;
        margin: 0 5px;
    }

    .tr, .tr a {
        background: LightGray;
        color: #000;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 2px 5px;
        margin: 0 5px;
    }

    tfoot > tr > td > button {
        color: #000;
        width: 33px;
        height: 33px;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 1px 5px 2px 5px;
        margin: 0 5px;
    }

    .activePager{background: white;}

    /* to toggle between (view and edit modes) of control box*/
    .ctrlView > div:first-child {
        display: block;
    }

    .ctrlView > div:last-child {
        display: none;
    }

    .ctrlEdit > div:first-child {
        display: none;
    }

    .ctrlEdit > div:last-child {
        display: block;
    }

    .hide {
        display: none;
    }
    .bg{
        background-color: yellow;
    }
    [disabled] {
        background-color: #cccccc;
        color: #666666;
        cursor: no-drop;
    }

/*    table tr td:nth-child(2) { display:none; }
*/

/*    @@foreach (var col in Model.columns)
    {
        @@(
        $"table tr td:nth-child({col.ColIndex}) {{ display:none; }}"
        );
    }*/
    
</style>
<div class='container mt-5 p-3'>
    <table id="table@(Model.grid.GridName)"></table>
    <form id="form@(Model.grid.GridName)"></form>
</div>

@{
    string grid = JsonConvert.SerializeObject(Model.grid);
    string columns = JsonConvert.SerializeObject(Model.columns);
    object rows = JsonConvert.SerializeObject(Model.rows);
    string footer = JsonConvert.SerializeObject(Model.footer);
}

<script type="text/javascript">

const grid = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(grid)')));
const columns = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(columns)')));
let footer = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(footer)')));
let rows = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(rows)')));

const colsLength = columns.length;
let controlObj;
let messageObj;
let row;

const table = document.getElementById(`table${grid.GridName}`);
const form = document.getElementById(`form${grid.GridName}`);
// ---------------------------------------------------------------------------- table start
HTMLTableElement.prototype.addHeader = addHeader;
function addHeader() {
    let THead; if (this.tHead===undefined||this.tHead===null){THead=this.createTHead();}else{return;}
    row = THead.insertRow(0); row.id = 'headerRow'; row.className = 'th';
    columns.map((col) => { row.addHeaderCell(col);  });
}
HTMLTableElement.prototype.addFooter = addFooter;
function addFooter() {
    let TFoot; if (this.tFoot === undefined || this.tFoot === null) { TFoot = this.createTFoot(); }
    else { this.deleteTFoot(); TFoot = this.createTFoot(); }
    row = TFoot.insertRow(0); row.id = 'footerRow'; row.dataset.currentpage = 1;
    let newCell = row.insertCell();
    newCell.colSpan = colsLength + 1;
    newCell.style = 'text-align:center;';
    let prevMin = footer.fRange[0] - 1;
    newCell.innerHTML = `<button data-pager='prev-${prevMin}' onclick="onPaging('prev', '${prevMin}')" ${footer.isPrevDisabled} class="bi bi-chevron-left"></button>`;
    footer.fRange.map((fBtn) => {
        var IsActive = (fBtn == footer.activeBtn ? "class='activePager'" : "");
        newCell.innerHTML += `<button data-pager='${fBtn}' ${IsActive} onclick="onPaging('page', '${fBtn}')">${fBtn}</button>`;
    });
    let rangeMax = footer.fRange[footer.fRange.length - 1] + 1;
    newCell.innerHTML += `<button data-pager='next-${rangeMax}' onclick="onPaging('next', '${rangeMax}')" ${footer.isNextDisabled} class="bi bi-chevron-right"></button>`;
}
HTMLTableElement.prototype.addRow = addRow;
function addRow(data){
    let rowId = Math.floor((Math.random() * 100000) + 1);
    let TBody = ((this.tBodies.length == 0)? this.createTBody() : this.tBodies[0]);
    row = TBody.insertRow(-1); 
    row.id = rowId; row.className = 'tr';
    Object.entries(data).map(([key, value], index) => { row.addCell(columns[index], value); });
    let targetObject = columns.find(obj => obj.ColName === "ctrl");

    row.addCell(messageObj, '<b>هل انت متاكد من الحذف !</b>');
    row.addCell(controlObj, rowId);
}

HTMLTableRowElement.prototype.addCell = addCell;
function addCell(col, val) {
  console.log(val)
  if(col.ColName == 'ctrl') {val = controlBox(val);}
  let newCell = this.insertCell();
  newCell.setAttribute("style", (col.IsVisable === true ? '' : 'display:none;'));
  newCell.className = (col.ColName == 'msg'?'hide':'ctrlView');
  newCell.dataset.col = col.ColName;
  newCell.innerHTML = (col.ColName != 'ctrl' && col.ColName != 'msg') ? cellContent(col.InputType, col.ColName, col.ColTitle, val): val;
  newCell.colSpan = (col.ColName == 'msg'? colsLength:0);
}
HTMLTableRowElement.prototype.addHeaderCell = addHeaderCell;
function addHeaderCell(col){
  let newCell = this.insertCell();
  newCell.setAttribute("style", (col.IsVisable === true ? '': 'display:none;'));
  newCell.className = (col.ColName == 'msg'?'hide':'ctrlView');
  newCell.dataset.col = col.ColName;
  newCell.innerHTML = col.KeyType == "PK" ? "" : (col.ColName=="ctrl") ? controlBox('headerRow') : cellContent(col.InputType, col.ColName, col.ColTitle, '', true);
}
HTMLTableElement.prototype.emptyBody = emptyBody;
function emptyBody(){
    this.tBodies[0].remove();
    this.createTBody();
}
function cellContent(type, name, dname, val, isHeader = false){
  return (isHeader === true) ?
  `<div>${dname}</div><div>${dname}<input data-hinput='${name}' type='${type}' name='${name}' value='${val}'></div>`: // for header true
  `<div>${val}</div><div>${dname}<input data-rinput='${name}' type='${type}' name='${name}' value='${val}'></div>`; // for normal row false default
}
const controlBox = (rowId) => {
  if (rowId == "headerRow"){
        return `<div><a href='#' class='bi bi-plus' onclick="toggleRow('headerRow')"></a><a href='#' class='bi bi-caret-down' onclick="alert('DDL')"></a></div><div><a href='#' class='bi bi-x' id='toggle${rowId}' onclick="toggleRow('headerRow')"></a><a href='#' class='bi bi-check' onclick="onSave('headerRow')"></a></div>`; 
  } else {
        return `<div><a href='#' class='bi bi-pencil-square' onclick="toggleRow('${rowId}')"></a><a href='#' class='bi bi-trash3' onclick="toggleConfirm('${rowId}')"></a></div><div><a href='#' class='bi bi-x' id='toggle${rowId}' onclick="toggleRow('${rowId}')"></a><a href='#' class='bi bi-check' id='action${rowId}' onclick="actionRow('${rowId}')"></a></div>`;
  }
}
// ---------------------------------------------------------------------------- table end

// ---------------------------------------------------------------------------- table Action start
window.onload =  populateTable();
function populateTable(){
    controlObj = { ColName: 'ctrl', KeyType: 'Sys', ColTitle: '', IsVisable: true };
    messageObj = { ColName: 'msg', KeyType: 'Sys', ColTitle: '', IsVisable: false };
    columns.push(controlObj);
    columns.push(messageObj);
    table.addHeader();
    rows.map(row => { table.addRow(row); });
    table.addFooter();
}
function onSave(rowId){
    let row = document.getElementById(rowId);
    let footerRow = table.tFoot.rows[0];
    let currentPage = footerRow.dataset.currentpage;
    let formData = getFormData(row); 
    
    fetch(`${grid.OnSaveAction}?fotId=${currentPage}` , {
    method: 'POST',
    body: formData
    })
    .then(response => response.json())
    .then(data => function(){ console.log(data); /*refreshGrid(data); */})
    .catch(err => console.log(err));
    //let jsonRow = {};
    //[...row.cells].map(cell => {
    //  if(cell.dataset.col != 'ctrl') { jsonRow[cell.dataset.col] = cell.lastChild.lastChild.value; }
    //});
    //table.addRow(jsonRow,'row'); 
}
function onDelete(rowId){
    let footerRow = table.tFoot.rows[0];
    let currentPage = footerRow.dataset.currentpage;
    //callAction(`${grid.OnDeleteAction}`, new { id: rowId, fotId: currentPage },
    //(data) => { alert(rowId) },
    //(err) => { alert('err'); console.log(err); });
    alert("delete")
}
function getFormData(row){
    form.innerHTML = "";
    let clonedRow = row.cloneNode(true)
    form.appendChild(clonedRow);
    let formData = new FormData(form);
    form.innerHTML = "";
    return formData;
}

function onPaging(nav, fotId) {
    const jsonObj = { nav: nav, fotId: fotId };
    callAction(`${grid.OnPagingAction}`, jsonObj,
         (data)=> {
            data = JSON.parse(data);
        if (nav == 'page') {
            document.querySelector('.activePager').classList.remove('activePager');
            document.querySelector(`[data-pager='${fotId}']`).classList.add('activePager');
            table.emptyBody(); 
            data.map(row => { table.addRow(row); }); 
        } else {
            refreshGrid(data);
        }
        let footerRow = table.tFoot.rows[0];
        footerRow.dataset.currentpage = fotId;
    } , 
    (err)=>{ alert('err'); console.log(err);} );
}
function refreshGrid(data){
        const getRows = data.rows;
        footer = data.footer;
        table.emptyBody();
        getRows.map(row => { table.addRow(row); });
        table.addFooter(footer);
}
function toggleConfirm(rowId){
    let row = document.getElementById(rowId);
        document.getElementById(`toggle${rowId}`).onclick = function () { toggleConfirm(rowId); };
        document.getElementById(`action${rowId}`).onclick = function () { onDelete(rowId); };
    [...row.cells].map(cell => {  
      if (cell.dataset.col != 'ctrl') {cell.classList.toggle('hide');}
      else {cell.classList.toggle('ctrlView');cell.classList.toggle('ctrlEdit');}
    });
}
function toggleRow(rowId) {
    let row = document.getElementById(rowId);
    document.getElementById(`toggle${rowId}`).onclick = function() { toggleRow(rowId); };
    if (rowId != 'headerRow') { document.getElementById(`action${rowId}`).onclick = function () { onSave(rowId); } };
    [...row.cells].map(cell => {
    cell.classList.toggle('ctrlEdit');
    cell.classList.toggle('ctrlView');
    })
}

// ---------------------------------------------------------------------------- table Action end

function callAction(url, dataJson, callbackOk, callbackErr){

    const params = new URLSearchParams();
    Object.entries(dataJson).map(([key, val]) => { params.append(key, val); });

    var requestOptions = {
      method: 'POST',
      body: params
    };

    fetch(url, requestOptions)
    .then(response => response.json())
    .then(result => callbackOk(result))
    .catch(err => callbackErr(err));
}
 

</script>