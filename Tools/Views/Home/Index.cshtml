@using System.Data;
@using Newtonsoft.Json;
@using System.Web;
@using Tools.Tools.Grid;
@model Grid

<style type="text/css">

    table {
        width: 100%;
    }

    td {
        width: 200px;
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==) repeat;
    }

    td, th {
        padding: 15px 10px;
        border: 1px solid #999;
        text-align: right;
    }

    .th, .th a {
        background: gray;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 2px 5px;
        margin: 0 5px;
    }

    .tr, .tr a {
        background: LightGray;
        color: #000;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 2px 5px;
        margin: 0 5px;
    }

    tfoot > tr > td > button {
        color: #000;
        width: 33px;
        height: 33px;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 1px 5px 2px 5px;
        margin: 0 5px;
    }

    .activePager{background: white;}

    /* to toggle between (view and edit modes) of control box*/
    .ctrlView > div:first-child {
        display: block;
    }

    .ctrlView > div:last-child {
        display: none;
    }

    .ctrlEdit > div:first-child {
        display: none;
    }

    .ctrlEdit > div:last-child {
        display: block;
    }

    .hide {
        display: none;
    }

    /*
    table tr td:nth-child(2) {
      display:none;
    }*/


    [disabled] {
        background-color: #cccccc;
        color: #666666;
        cursor: no-drop;
    }
</style>

<div class='container mt-5 p-3'>
    <table id="@Model.grid.GridName">
        <partial name="_InitGrid" model="@Model" />
    </table>
</div>

@{
    string grid = JsonConvert.SerializeObject(Model.grid);
    string columns = JsonConvert.SerializeObject(Model.columns);
    string rows =  Model.rows;
    string footer = JsonConvert.SerializeObject(Model.Footer);
}

<script type="text/javascript">

// DefaultColumnWidth, DefaultCtrlColumnWidth, GridName, GridTitle, GridType, ItemsPerPage, OnDeleteAction, OnPagingAction, OnSaveAction, PagerSize, PaginationType
const grid = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(grid)')));
// {colIndex:0, colName:'name', colTitle:'الاسم', isVisable:true, colWidth: 200, inputType: 'text', keyType:'pk'}
const columns = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(columns)')));
               //[{colIndex:0, colName:'name', colTitle:'الاسم', isVisable:true, colWidth: 200, inputType: 'text', keyType:'pk'},
               //{colIndex:1, colName:'email', colTitle:'ايميل', isVisable:true, colWidth: 200, inputType: 'text', keyType:'normal'},
               //{colIndex:2, colName:'tel', colTitle:'تلفون', isVisable:true, colWidth: 200, inputType: 'text', keyType:'normal'},
               //{colIndex:3, colName:'city', colTitle:'مدينة', isVisable:true, colWidth: 200, inputType: 'list', keyType:'fk'}]
const colsLength = columns.length;
const rows = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(rows)')));
    //[{name:'ali',email:'ali@@email.com',tel:'123',city:'egypt'},
    //{ name: 'medoo', email: 'medoo@@email.com', tel: '456', city: 'UK' },
    //{ name: 'keto', email: 'keto@@email.com', tel: '789', city: 'USA' }];
let footer = JSON.parse(JSON.parse(JSON.stringify('@Html.Raw(footer)')));
//{isPrevDisabled: false, isNextDisabled: true, activeBtn: 4, fRange: [1,2,3,4,5]}
var table = document.getElementById(grid.gridName);   

// ---------------------------------------------------------------------------- table start
HTMLTableElement.prototype.addRow = addRow;
function addRow(data, rowType){
  let row;
  switch(rowType){
    case 'header':
        let THead;
        if (this.tHead===undefined||this.tHead===null){THead=this.createTHead();}else{return;}
        row = THead.insertRow(0); 
        row.id = 'headerRow';
        row.className = 'th';
        data.push({colName:'ctrl', colTitle:'', isVisable:true});
        data.map((item) => { row.addHeaderCell(item.colName, item.colTitle, item.isVisable);  }); 
    break;
      
    case 'row': 
        let rowId = Math.floor((Math.random() * 100000) + 1);
        let TBody = ((this.tBodies.length == 0)? this.createTBody() : this.tBodies[0]);
        row = TBody.insertRow(-1); 
        row.id = rowId;
        row.className = 'tr';
        Object.entries(data).map(([key, value]) => {  row.addCell(key, value) });
        row.addCell('msg', '<b>هل انت متاكد من الحذف !</b>');
        row.addCell('ctrl', rowId);
      break;
      
    case 'footer':
      let TFoot;
      if (this.tFoot === undefined || this.tFoot === null){ TFoot = this.createTFoot(); }
      else{ this.deleteTFoot();this.createTFoot(); }
      row = TFoot.insertRow(0);
      row.id = 'footerRow';
      let newCell = row.insertCell();
      newCell.colSpan = colsLength+1;
      newCell.style = 'text-align:center;';
        let rangeMin = data.fRange[0];
        newCell.innerHTML = `<button onclick="onPaging('prev', '${rangeMin}')" ${data.isPrevDisabled} class="bi bi-chevron-left"></button>`;
      data.fRange.map((fBtn) => {
          let IsActive = fBtn == data.activeBtn ? 'activePager' : ''; 
          newCell.innerHTML += `<button class='${IsActive}' onclick="onPaging('page', '${fBtn}')">${fBtn}</button>`;
      });
        let rangeMax = data.fRange[data.fRange.length - 1];
        newCell.innerHTML += `<button onclick="onPaging('next', '${rangeMax}')" ${data.isNextDisabled} class="bi bi-chevron-right"></button>`; 
      break;
  } 
}
HTMLTableRowElement.prototype.addCell = addCell;
function addCell(key, val){
  if(key == 'ctrl') {val = controlBox(val);}
  let newCell = this.insertCell();
  let col = columns[newCell.cellIndex];
  newCell.dataset.col = key;
  newCell.innerHTML = (key != 'ctrl' && key != 'msg') ? cellContent('text', key, col.colTitle, val): val;
  newCell.className = (key == 'msg'?'hide':'ctrlView');
  newCell.colSpan = (key == 'msg'?colsLength:0);
}
HTMLTableRowElement.prototype.addHeaderCell = addHeaderCell;
function addHeaderCell(name, dName, isVisable){
  let newCell = this.insertCell(); 
  newCell.setAttribute("style", (isVisable === true? '': 'display:none;'));
  newCell.className = 'ctrlView'; 
  newCell.dataset.col = name; 
  newCell.innerHTML = (name=="ctrl") ? controlBox('headerRow') : cellContent('text', name, dName, '', true);
}
HTMLTableElement.prototype.emptyBody = emptyBody;
function emptyBody(){
        this.tBodies[0].remove();
        this.createTBody();
}
function cellContent(type, name, dname, val, isHeader = false){
  return (isHeader === true) ?
  `<div>${dname}</div><div>${dname}<input type='${type}' name='${name}' value='${val}'></div>`: // for header true
  `<div>${val}</div><div>${dname}<input type='${type}' name='${name}' value='${val}'></div>`; // for normal row false default 
}
const controlBox = (rowId) => {
  if (rowId == "headerRow"){
        return  `<div><a href='#' class='bi bi-plus' onclick="toggleRow('headerRow')"></a><a href='#' class='bi bi-caret-down' onclick="alert('DDL')"></a></div><div><a href='#' class='bi bi-x' id='toggle${rowId}' onclick="toggleRow('headerRow')"></a><a href='#' class='bi bi-check' onclick="onSave('headerRow')"></a></div>`; 
  } else {
        return `<div><a href='#' class='bi bi-pencil-square' onclick="toggleRow('${rowId}')"></a><a href='#' class='bi bi-trash3' onclick="toggleConfirm('${rowId}')"></a></div><div><a href='#' class='bi bi-x' id='toggle${rowId}' onclick="toggleRow('${rowId}')"></a><a href='#' class='bi bi-check' onclick="alert('edit or delete ${rowId}')"></a></div>`;
  }
}
// ---------------------------------------------------------------------------- table end

// ---------------------------------------------------------------------------- table Action start
//window.onload =  populateTable();
function populateTable(){
    table.addRow(columns,'header');
    rows.map(row => { table.addRow(row, 'row'); });
    table.addRow(footer, 'footer');
}
function onSave(rowId){
    let row = document.getElementById(rowId); 
    let jsonRow = {};
    [...row.cells].map(cell => { 
      if(cell.dataset.col != 'ctrl') { jsonRow[cell.dataset.col] = cell.lastChild.lastChild.value; }
      //else { jsonRow[cell.dataset.col] = controlBox(rowId); }
    });
    table.addRow(jsonRow,'row'); 
}
function onDelete(rowId){
  alert('delete ' + rowId)
}
function onPaging(nav, fotId) {
    sbmt(`@Model.grid.OnPagingAction?nav=${nav}&fotId=${fotId}`, 'get', 
    (data)=> {
        let jsonObj = JSON.parse(JSON.parse(data));
        
            if (nav == 'page') { table.emptyBody(); jsonObj.map(row => { table.addRow(row, 'row'); }); }
        else {
            data.map(row => { table.addRow(row, 'row'); });
            table.addRow(footer, 'footer');
        }
    } , 
    (err)=>{ alert('err'); console.log(err);} );
}
function toggleConfirm(rowId){
    let row = document.getElementById(rowId); 
    document.getElementById(`toggle${rowId}`).onclick = function() { toggleConfirm(rowId); };
    [...row.cells].map(cell => {  
      if (cell.dataset.col != 'ctrl') {cell.classList.toggle('hide');}
      else {cell.classList.toggle('ctrlView');cell.classList.toggle('ctrlEdit');}
    });
}
function toggleRow(rowId){
  let row = document.getElementById(rowId);
  document.getElementById(`toggle${rowId}`).onclick = function() { toggleRow(rowId); };
  [...row.cells].map(cell => {
    cell.classList.toggle('ctrlEdit');
    cell.classList.toggle('ctrlView');
  })
}
// ---------------------------------------------------------------------------- table Action end


function sbmt(url, method, callbackOk, callbackErr){
    fetch(url, { method: method })
    .then(response => response.text())
    .then((data) => {
        callbackOk(data);
    })
    .catch(err => { 
        callbackErr(err);
    });
}
    
</script>